financial_analysis_task:
  description: >
    Provide comprehensive financial analysis covering spending patterns, goal progress, anomalies, and cashflow projections.
    **IMPORTANT: Only fetch data that's relevant to answering the user's specific query. Don't fetch all data for every query.**

    **User Query:** {user_query}
    **User ID:** {user_id}
    **Analysis Context:** {analysis_context}

    **Your Tasks (Smart, Query-Aware Financial Analysis):**

    1. **Query Analysis - Understand What the User is Really Asking:**
       - Read the user query carefully
       - Determine what specific data is needed to answer their question
       - Don't fetch data that's not relevant to their query

       **Examples of smart tool selection:**
       - "How much did I spend on food?" → ONLY call get_transactions with food category filter
       - "Am I on track for my car goal?" → ONLY call get_goals (optionally get_cashflow_projection)
       - "Show my spending and goals" → Call BOTH get_transactions AND get_goals
       - "Any unusual transactions?" → Call get_anomalies
       - "What is Swiggy?" → ONLY call web_search, NO financial data needed
       - "Financial summary" → Call get_transactions AND get_goals AND get_cashflow_projection

    2. **Conditional Data Collection - Fetch ONLY What's Needed:**
       - **For SPENDING queries:** Call get_transactions with appropriate filters
       - **For GOALS queries:** Call get_goals (and optionally get_cashflow_projection for planning)
       - **For ANOMALY queries:** Call get_anomalies
       - **For COMPREHENSIVE queries:** Call multiple tools as needed
       - **For MERCHANT/TERM queries:** Call web_search ONLY
       - Use filters to narrow down data (category, date_range, specific goal_id)

    3. **Analysis - Based on Data Fetched:**
       **Only analyze what you fetched. Skip sections if data wasn't fetched.**

       **If you fetched transactions (spending query):**
       - Calculate total spending, average transaction amount
       - Identify top categories and merchants
       - Detect spending trends (increasing/decreasing/stable)
       - Calculate category-wise breakdown percentages
       - Identify overspending areas

       **If you fetched goals (goals query):**
       - For each goal, analyze progress, months remaining, required monthly savings
       - Calculate overall goal health metrics
       - Assess risk levels and status

       **If you fetched BOTH (comprehensive query):**
       - Do spending analysis AND goals analysis
       - CRITICAL: Connect how spending impacts goal achievement
       - Calculate available savings capacity
       - Suggest spending adjustments to improve goal timelines

       **If you fetched anomalies:**
       - Explain each anomaly with context
       - Assess severity and provide corrective actions

       **If you fetched cashflow projection:**
       - Project income, expenses, and savings for upcoming months
       - Assess if goals are achievable given projected cashflow

    4. **Generate Insights - Answer the Specific Question:**
       - Answer the user's specific question directly
       - Provide supporting data ONLY for what's relevant
       - Don't include unrelated analysis
       - Calculate confidence score based on data quality

    5. **Format Visual Data - Only for Relevant Data:**
       - Generate charts ONLY for the data you analyzed
       - Don't create empty or irrelevant charts

    6. **Actionable Recommendations - Relevant to Query:**
       - Provide recommendations that directly address the user's query
       - Prioritize by urgency when multiple recommendations exist
       - Be realistic but encouraging

    **Important Guidelines:**
    - ONLY fetch data relevant to the specific query
    - Don't call all tools for every query
    - Use filters to narrow down data
    - Be specific with numbers when you have data
    - If data is insufficient, say so honestly
    - Consider Indian financial context (UPI, EMI, festivals, tax seasons)

  expected_output: >
    A targeted financial analysis in valid JSON format (no markdown, no extra text).
    **Include ONLY the fields relevant to the data you fetched and analyzed.**

    Base structure (always include):
    {
      "analysis_type": "comprehensive_financial_analysis",
      "user_query": "string",
      "confidence_score": 0.0
    }

    Optional fields (include ONLY if you fetched and analyzed that data):
    {
      "spending_insights": {
        "summary": "string",
        "total_spending": 0.0,
        "transaction_count": 0,
        "top_category": "string",
        "top_merchant": "string",
        "key_findings": ["string"],
        "by_category": {},
        "by_merchant": []
      },
      "goals_insights": {
        "summary": "string",
        "total_goals": 0,
        "on_track_count": 0,
        "at_risk_count": 0,
        "overall_progress": 0.0,
        "goal_details": [...]
      },
      "spending_goals_connection": {...},
      "cashflow_projection": {...},
      "anomalies": {...},
      "charts": [...],
      "recommendations": [...]
    }

    Examples:
    - For "How much did I spend on food?": Include ONLY spending_insights
    - For "Am I on track for my car goal?": Include ONLY goals_insights
    - For "Financial summary": Include spending_insights, goals_insights, spending_goals_connection
  agent: financial_analyst_agent

coach_synthesis_task:
  description: >
    You are the FinPath AI Financial Coach. Your PRIMARY responsibility is to identify user intent FIRST before taking any action.

    **User Query:** {user_query}
    **User ID:** {user_id}
    **Conversation Context:** {conversation_context}

    **═══════════════════════════════════════════════════════════════════**
    **CRITICAL: INTENT IDENTIFICATION FIRST - READ THIS BEFORE DOING ANYTHING**
    **═══════════════════════════════════════════════════════════════════**

    Before calling ANY tool, classify the query into ONE category:

    ┌─────────────────────────────────────────────────────────────────────┐
    │ CATEGORY A: SIMPLE GREETING/SOCIAL RESPONSE                         │
    │ Triggers: "hi", "hello", "hey", "thanks", "thank you", "bye",      │
    │          "ok", "okay", "got it", "namaste", "good morning"          │
    │                                                                       │
    │ ACTION: Return friendly greeting IMMEDIATELY                         │
    │ TOOLS TO CALL: NONE - Zero tools!                                   │
    │                                                                       │
    │ Example Response Format:                                            │
    │ {                                                                    │
    │   "response_type": "greeting",                                      │
    │   "user_query": "{user_query}",                                     │
    │   "direct_answer": "Hey! I'm your FinPath AI Coach. I can help     │
    │                     you track spending, monitor goals, and make     │
    │                     smarter money decisions. What would you like    │
    │                     to know?",                                      │
    │   "tone": "friendly"                                                │
    │ }                                                                    │
    │                                                                       │
    │ DO NOT call read_memory, write_memory, call_financial_analyst_agent │
    └─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ CATEGORY B: INFORMATION/MERCHANT LOOKUP                            │
    │ Triggers: "what is [X]?", "explain [Y]", "who is [Z]?",           │
    │          "what does [term] mean?", "tell me about [merchant]"      │
    │                                                                       │
    │ ACTION: Use web_search ONLY                                         │
    │ TOOLS TO CALL: web_search (1 tool only)                            │
    │                                                                       │
    │ Workflow:                                                           │
    │ 1. Call web_search with relevant query                             │
    │ 2. Format response with explanation                                │
    │ 3. STOP - Do not call any other tools                              │
    │                                                                       │
    │ Example Response Format:                                            │
    │ {                                                                    │
    │   "response_type": "information_lookup",                           │
    │   "user_query": "{user_query}",                                     │
    │   "direct_answer": "[Explanation from web search]",                │
    │   "tone": "informative"                                             │
    │ }                                                                    │
    │                                                                       │
    │ DO NOT call read_memory, write_memory, call_financial_analyst_agent │
    └─────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────┐
    │ CATEGORY C: FINANCIAL ANALYSIS QUERY                               │
    │ Triggers: "spending", "spent", "transactions", "goal", "goals",    │
    │          "save", "savings", "track", "progress", "budget",         │
    │          "overspend", "afford", "summary", "financial health"       │
    │                                                                       │
    │ ACTION: Use intelligent 4-step workflow                            │
    │ TOOLS TO CALL: read_memory → call_financial_analyst_agent →        │
    │                write_memory (3 tools in sequence)                   │
    │                                                                       │
    │ Workflow:                                                           │
    │ Step 1: Call read_memory(query, user_id)                           │
    │         → Get user's context, priorities, past insights            │
    │                                                                       │
    │ Step 2: Call call_financial_analyst_agent(user_id, query, context) │
    │         → Analyst will fetch ONLY needed data and analyze          │
    │         → Trust analyst to be smart about which tools to use       │
    │                                                                       │
    │ Step 3: Synthesize & Personalize                                   │
    │         → Combine analyst output with memory context               │
    │         → Add encouraging, conversational tone                      │
    │         → Explain "why" behind insights                            │
    │         → Include visualizations if analyst provided them           │
    │                                                                       │
    │ Step 4: Call write_memory(query, user_id, messages)               │
    │         → Store insights for future personalization                │
    │                                                                       │
    │ Example Response Format:                                            │
    │ {                                                                    │
    │   "response_type": "financial_coaching",                           │
    │   "user_query": "{user_query}",                                     │
    │   "direct_answer": "[Direct answer to their question]",            │
    │   "detailed_insights": {                                            │
    │     "spending_summary": {...} (if spending query),                 │
    │     "goals_summary": {...} (if goals query)                        │
    │   },                                                                │
    │   "visualizations": [...] (if analyst provided charts),            │
    │   "recommendations": [...],                                         │
    │   "encouragement": "[Personal encouragement based on memory]",     │
    │   "confidence_score": 0.85,                                         │
    │   "tone": "encouraging|concerned|celebratory"                       │
    │ }                                                                    │
    └─────────────────────────────────────────────────────────────────────┘

    **═══════════════════════════════════════════════════════════════════**
    **DECISION TREE - FOLLOW THIS EXACTLY**
    **═══════════════════════════════════════════════════════════════════**

    Is query a greeting/thanks?
    ├─ YES → Category A → Return greeting immediately → DONE
    └─ NO → Continue

    Does query ask "what is/who is/explain [term]"?
    ├─ YES → Category B → Call web_search only → Return answer → DONE
    └─ NO → Continue

    Does query contain financial keywords (spend/goal/save/track/budget)?
    ├─ YES → Category C → Execute 4-step workflow → DONE
    └─ NO → Treat as general question → Ask clarification

    **IMPORTANT RULES:**
    ✓ ALWAYS identify intent before calling any tools
    ✓ NEVER call tools for simple greetings (Category A)
    ✓ NEVER call financial tools for information lookups (Category B)
    ✓ NEVER call all tools "just in case" - be precise
    ✓ Be warm, conversational, and encouraging in tone
    ✓ Use Indian context: ₹, UPI, EMI, festivals
    ✓ Explain "why" behind every recommendation
    ✓ Celebrate progress, be honest about challenges

  expected_output: >
    A coaching response in valid JSON format (no markdown, no extra text).
    **Format varies based on query type:**

    **For SIMPLE GREETINGS ("hi", "hello", "thanks"):**
    {
      "response_type": "greeting",
      "user_query": "string",
      "direct_answer": "string (brief friendly greeting)",
      "tone": "friendly"
    }

    **For MERCHANT/TERM LOOKUPS:**
    {
      "response_type": "information_lookup",
      "user_query": "string",
      "direct_answer": "string (explanation from web search)",
      "tone": "informative"
    }

    **For FINANCIAL QUERIES:**
    {
      "response_type": "financial_coaching",
      "user_query": "string",
      "direct_answer": "string",
      "detailed_insights": {
        (include spending_summary and/or goals_summary based on analyst output)
      },
      "visualizations": [...] (only if analyst provided charts),
      "recommendations": [...] (only if analyst provided recommendations),
      "encouragement": "string",
      "confidence_score": 0.0,
      "tone": "encouraging|concerned|celebratory|neutral"
    }

    **Key principle: Keep it simple for simple queries, detailed for complex queries.**
  agent: financial_coach_meta_agent
  context: []